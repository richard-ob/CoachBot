<div class="container py-4">
    <ng-container *ngIf="tournament && !isLoading; else spinner">
        <h5>{{tournament.name}}</h5>
        <div class="card">
            <div class="card__header">
                <h4>Manage</h4>
            </div>
            <div class="card__content">
                <button type="button" class="btn btn-primary mx-1"
                    [swal]="{ title: 'Are you sure?', text: 'This will generate the schedule of matches, and if the schedule is already generated, will clear the existing schedule and matches.', icon: 'warning', showCancelButton: true }"
                    (confirm)="generateSchedule()">Generate
                    Schedule</button>
                <button *ngIf="!tournament.isPublic" type="button" class="btn btn-primary mx-1"
                    (click)="toggleIsPublic()">Make Public</button>
                <button *ngIf="tournament.isPublic" type="button" class="btn btn-primary mx-1"
                    (click)="toggleIsPublic()">Make Private</button>
                <button type="button" class="btn btn-primary mx-1"
                    [swal]="{ title: 'Are you sure?', text: 'This will generate the player snapshots for the fantasy game, meaning the fantasy game must be completely reset if further player changes required. Therefore this should only be done after transfer windows end.', icon: 'warning', showCancelButton: true }"
                    (confirm)="generateFantasyTeamSnapshots()">Open Fantasy Game</button>
            </div>
        </div>
        <div class="card">
            <div class="card__header">
                <h4>Start Date</h4>
            </div>
            <input class="form-control" type="date" [(ngModel)]="tournament.startDate" name="startDate">
            <div class="card__content">
                <button type="button" class="btn btn-primary mx-1" (click)="updateStartDate()">Save</button>
            </div>
        </div>
        <div class="card">
            <div class="card__header">
                <h4>Tournament Staff</h4>
            </div>
            <div class="card__content">
                <div *ngIf="!tournament.tournamentStaff.length" class="alert alert-info">There are no
                    staff added yet</div>
                <table *ngIf="tournament.tournamentStaff.length" class="table table-striped">
                    <thead>
                        <th>Name</th>
                        <th>Role</th>
                        <th>Date Since</th>
                    </thead>
                    <tbody>
                        <tr *ngFor="let staff of tournament.tournamentStaff">
                            <td>{{staff.player.name}}</td>
                            <td>{{staff.role | tournamentStaffRole}}</td>
                            <td>{{staff.createdDate | date}}</td>
                        </tr>
                    </tbody>
                </table>
                <form (ngSubmit)="createTournamentStaff()" #addStaffForm="ngForm">
                    <h5>Add Staff</h5>
                    <div class="form-group">
                        <label class="control-label" for="input-default">Player</label>
                        <input class="form-control" type="number" [(ngModel)]="tournamentStaff.playerId"
                            name="staffPlayerId" required>
                    </div>
                    <div class="form-group">
                        <label class="control-label" for="input-default">Staff Role</label>
                        <select class="form-control" id="input-default" [(ngModel)]="tournamentStaff.role"
                            name="staffRole" required placeholder="Select role..">
                            <option [ngValue]="tournamentRole.Organiser">Organiser</option>
                            <option [ngValue]="tournamentRole.MatchAdmin">Match Admin</option>
                            <option [ngValue]="tournamentRole.Streamer">Streamer</option>
                            <option [ngValue]="tournamentRole.Commentator">Commentator</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary float-right"
                        [disabled]="isSaving || isLoading || addStaffForm.invalid">
                        <i *ngIf="isSaving || isLoading" class="fas fa-circle-notch fa-spin"></i>
                        Save
                    </button>
                </form>
            </div>
        </div>
        <app-tournament-match-day-slot-manager [tournamentId]="tournamentId">
        </app-tournament-match-day-slot-manager>
        <div class="card" *ngFor="let stage of tournament.tournamentStages">
            <div class="card__header card__header--has-btn">
                <h4>{{stage.name}}</h4>
            </div>
            <div class="card__content">
                <h5>New Group</h5>
                <form (ngSubmit)="createTournamentGroup(stage.id)" #newGroupForm="ngForm">
                    <div class="form-group">
                        <label>Name</label>
                        <input [(ngModel)]="tournamentGroup.name" name="tournamentGroupName" type="text"
                            class="form-control" required placeholder="e.g. A Tier, Premier, etc">
                    </div>
                    <button type="submit" class="btn btn-primary mx-1" [disabled]="newGroupForm.invalid">
                        Add Group
                    </button>
                </form>
                <h5 class="mt-3">Groups </h5>
                <div *ngIf="!stage.tournamentGroups || !stage.tournamentGroups.length" class="alert alert-info">
                    No groups added yet. A tournament must have at least one group.
                </div>
                <div *ngFor="let group of stage.tournamentGroups" class="mt-4">
                    <h6>
                        {{group.name}}
                        <button class="btn btn-outline-danger btn-xs" type="button"
                            (click)="deleteTournamentGroup(group.id)">
                            Remove
                        </button>
                    </h6>
                    <div *ngIf="group.tournamentGroupTeams.length; else noTeamsAdded" class="table table-stripe">
                        <label>Team</label>
                        <ul>
                            <li *ngFor="let groupTeam of group.tournamentGroupTeams">
                                {{groupTeam.team.name}}
                                <button class="btn btn-outline-danger btn-xs" type="button"
                                    (click)="removeTournamentGroupTeam(groupTeam.team.id, group.id)">
                                    Remove
                                </button>
                            </li>
                        </ul>
                    </div>
                    <ng-template #noTeamsAdded>
                        <div class="alert alert-info">No teams added to group yet</div>
                    </ng-template>
                    <app-tournament-group-team-manager [tournamentGroupId]="group.id" (teamAdded)="loadTournament()">
                    </app-tournament-group-team-manager>
                    <h6 class="mt-3">Group Schedule</h6>
                    <table *ngIf="group.tournamentGroupMatches; else noScheduleGenerated" class="table table-striped">
                        <thead>
                            <th>Match Date</th>
                            <th>Home Team</th>
                            <th>Away Team</th>
                            <th>Phase</th>
                            <th>Actions</th>
                        </thead>
                        <tbody>
                            <tr *ngFor="let groupMatch of group.tournamentGroupMatches | orderBy: 'match.kickOff'">
                                <td>{{groupMatch.match.kickOff | date}}</td>
                                <td>{{groupMatch.match.teamHome?.name || groupMatch.teamHomePlaceholder || 'TBC'}}</td>
                                <td>{{groupMatch.match.teamAway?.name || groupMatch.teamAwayPlaceholder || 'TBC'}}</td>
                                <td>{{groupMatch.tournamentPhase.name}}</td>
                                <td>
                                    <button class="btn btn-primary btn-xs" type="button"
                                        (click)="editMatch(groupMatch.match.id)">
                                        Edit Match
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <ng-template #noScheduleGenerated>
                        <div class="alert alert-info">The schedule has not been generated yet</div>
                    </ng-template>
                </div>
            </div>
        </div>
    </ng-container>
    <ng-template #spinner>
        <app-spinner></app-spinner>
    </ng-template>
</div>